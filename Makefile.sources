# Makefile.sources - Advanced C Source Generation for PyMaSC
# Docker-based C source generation with parallel builds and dependency tracking

SHELL := /bin/bash
.PHONY: all clean check help py38 py39 py310 py311 py312 py313 platform-info docker-cleanup extract

# Configuration
PYTHON_VERSIONS := 3.8 3.9 3.10 3.11 3.12 3.13
DOCKER_COMPOSE_FILE := docker-compose.build.yml

# Platform detection for ARM64 x86intrin.h issues
UNAME_M := $(shell uname -m)
UNAME_S := $(shell uname -s)

# Docker platform configuration (handled in docker-compose.yml, not as command flag)
ifeq ($(UNAME_M),arm64)
    PLATFORM_NOTE := ARM64 detected: Using x86_64 emulation for BitArray compatibility
    DOCKER_COMPOSE_FILE := docker-compose.build.yml
else
    PLATFORM_NOTE := x86_64 detected: Native build
    DOCKER_COMPOSE_FILE := docker-compose.build.yml
endif

# Target definitions - versioned C files
CORE_MODULES := \
    PyMaSC/reader/bigwig \
    PyMaSC/core/readlen \
    PyMaSC/core/mappability \
    PyMaSC/core/successive/ncc \
    PyMaSC/core/successive/mscc \
    PyMaSC/core/bitarray/bitarray \
    PyMaSC/core/bitarray/mscc

# Version-specific targets for Python versions
py38:
	@echo "üêç Building C sources for Python 3.8..."
	@$(MAKE) -f Makefile.sources docker-build-py38

py39:
	@echo "üêç Building C sources for Python 3.9..."
	@$(MAKE) -f Makefile.sources docker-build-py39

py310:
	@echo "üêç Building C sources for Python 3.10..."
	@$(MAKE) -f Makefile.sources docker-build-py310

py311:
	@echo "üêç Building C sources for Python 3.11..."
	@$(MAKE) -f Makefile.sources docker-build-py311

py312:
	@echo "üêç Building C sources for Python 3.12..."
	@$(MAKE) -f Makefile.sources docker-build-py312

py313:
	@echo "üêç Building C sources for Python 3.13..."
	@$(MAKE) -f Makefile.sources docker-build-py313

# Main targets
all: platform-info $(foreach version,$(PYTHON_VERSIONS),py$(subst .,,$(version)))
	@echo ""
	@echo "üéâ All C source generation completed!"
	@echo "üìä Summary:"
	@$(MAKE) -f Makefile.sources show-summary

# Parallel build all versions (main entry point) - Isolated build design
parallel: platform-info
	@echo "üöÄ Starting isolated parallel C source generation (race-condition free)..."
	@echo "üì¶ Each container will build in its own isolated environment"
	@echo ""
	@# Build all containers in parallel
	@docker-compose -f $(DOCKER_COMPOSE_FILE) up --build --detach
	@echo ""
	@echo "‚è≥ Waiting for builds to complete..."
	@# Wait for all containers to finish
	@for version in $(PYTHON_VERSIONS); do \
		py_major_minor=$$(echo "$$version" | sed 's/\.//g'); \
		container="pymasc-build-py$$py_major_minor"; \
		echo "  Waiting for $$container..."; \
		docker wait "$$container" > /dev/null && echo "    ‚úÖ Completed" || echo "    ‚ùå Failed"; \
	done
	@echo ""
	@echo "üì• Extracting generated C files using rsync (preserving paths)..."
	@mkdir -p c_extracted
	@# Copy build tree from each container, then rsync only versioned C files (path-preserving)
	@for version in $(PYTHON_VERSIONS); do \
		py_major_minor=$$(echo "$$version" | sed 's/\.//g'); \
		container="pymasc-build-py$$py_major_minor"; \
		tmpdir="c_extracted/py$$py_major_minor"; \
		echo "  Copying build tree from $$container..."; \
		mkdir -p "$$tmpdir"; \
		if docker cp "$$container:/build/PyMaSC" "$$tmpdir/" 2>/dev/null; then \
			echo "    ‚úÖ Build tree copied"; \
			RSYNC_FILTER="--include=*/ --include=*_$${py_major_minor}.c --exclude=*"; \
			rsync -a --prune-empty-dirs $$RSYNC_FILTER "$$tmpdir/PyMaSC/" "PyMaSC/"; \
			echo "    ‚úÖ Synced Python $$version C sources"; \
		else \
			echo "    ‚ùå Failed to copy from container $$container"; \
		fi; \
	done
	@echo ""
	@echo "üßπ Cleaning up containers..."
	@docker-compose -f $(DOCKER_COMPOSE_FILE) down
	@echo ""
	@echo "üìä Organized C files via rsync (path-preserving)"
	@echo ""
	@echo "‚úÖ Isolated parallel build completed successfully!"
	@$(MAKE) -f Makefile.sources show-summary

# Legacy staging build (slower but safer for resource-constrained systems)
parallel-staged: platform-info
	@echo "üöÄ Starting staged parallel C source generation to avoid resource exhaustion..."
	@echo "üìä Building in groups to prevent memory overflow"
	@echo ""
	@echo "üèÉ‚Äç‚ôÇÔ∏è Group 1: Python 3.8 & 3.9..."
	@docker-compose -f $(DOCKER_COMPOSE_FILE) up --build build-py38 build-py39
	@echo ""
	@echo "üèÉ‚Äç‚ôÇÔ∏è Group 2: Python 3.10 & 3.11..."
	@docker-compose -f $(DOCKER_COMPOSE_FILE) up --build build-py310 build-py311
	@echo ""
	@echo "üèÉ‚Äç‚ôÇÔ∏è Group 3: Python 3.12..."
	@docker-compose -f $(DOCKER_COMPOSE_FILE) up --build build-py312
	@echo ""
	@echo "üìù Extracting and syncing C files via rsync..."
	@mkdir -p c_extracted
	@for version in $(PYTHON_VERSIONS); do \
		py_major_minor=$$(echo "$$version" | sed 's/\.//g'); \
		container="pymasc-build-py$$py_major_minor"; \
		tmpdir="c_extracted/py$$py_major_minor"; \
		mkdir -p "$$tmpdir"; \
		if docker cp "$$container:/build/PyMaSC" "$$tmpdir/" 2>/dev/null; then \
			RSYNC_FILTER="--include=*/ --include=*_$${py_major_minor}.c --exclude=*"; \
			rsync -a --prune-empty-dirs $$RSYNC_FILTER "$$tmpdir/PyMaSC/" "PyMaSC/"; \
			echo "  ‚úÖ Synced Python $$version C sources"; \
		fi; \
	done
	@echo ""
	@echo "‚úÖ Staged parallel build completed successfully!"

# Docker build commands for specific Python versions
docker-build-py38:
	@docker-compose -f $(DOCKER_COMPOSE_FILE) up --build build-py38
	@$(MAKE) -f Makefile.sources rename-version VERSION=3.8

docker-build-py39:
	@docker-compose -f $(DOCKER_COMPOSE_FILE) up --build build-py39
	@$(MAKE) -f Makefile.sources rename-version VERSION=3.9

docker-build-py310:
	@docker-compose -f $(DOCKER_COMPOSE_FILE) up --build build-py310
	@$(MAKE) -f Makefile.sources rename-version VERSION=3.10

docker-build-py311:
	@docker-compose -f $(DOCKER_COMPOSE_FILE) up --build build-py311
	@$(MAKE) -f Makefile.sources rename-version VERSION=3.11

docker-build-py312:
	@docker-compose -f $(DOCKER_COMPOSE_FILE) up --build build-py312
	@$(MAKE) -f Makefile.sources rename-version VERSION=3.12

docker-build-py313:
	@docker-compose -f $(DOCKER_COMPOSE_FILE) up --build build-py313
	@$(MAKE) -f Makefile.sources rename-version VERSION=3.13

# Rename generated C files with version suffix
rename-version:
	@if [ -z "$(VERSION)" ]; then echo "‚ùå ERROR: VERSION not specified"; exit 1; fi
	@echo "üìù Renaming C files for Python $(VERSION)..."
	@py_major_minor=$$(echo "$(VERSION)" | sed 's/\.//g'); \
	for f in $(foreach mod,$(CORE_MODULES),$(mod).c); do \
		if [ -f "$$f" ]; then \
			base_name="$${f%.c}"; \
			version_file="$${base_name}_$$py_major_minor.c"; \
			mv "$$f" "$$version_file"; \
			echo "  $$f -> $$version_file"; \
		fi; \
	done

# Rename all versions (for parallel build)
rename-all-versions:
	@for version in $(PYTHON_VERSIONS); do \
		$(MAKE) -f Makefile.sources rename-version VERSION=$$version; \
	done


# Smart dependency checking - comprehensive build dependency analysis
check-deps:
	@echo "üîç Smart Dependency Analysis..."
	@echo ""
	@$(MAKE) -f Makefile.sources check-bitarray-deps
	@echo ""
	@$(MAKE) -f Makefile.sources check-cython-deps
	@echo ""
	@$(MAKE) -f Makefile.sources check-docker-deps

# Check BitArray library dependencies
check-bitarray-deps:
	@echo "üì¶ BitArray Library Dependencies:"
	@bitarray_lib="external/BitArray/libbitarr.a"; \
	bitarray_src="external/BitArray"; \
	if [ ! -f "$$bitarray_lib" ]; then \
		echo "  ‚ùå Missing: $$bitarray_lib"; \
		echo "     ‚Üí Run: cd $$bitarray_src && make libbitarr.a"; \
	else \
		newer_files=$$(find "$$bitarray_src" -name "*.c" -o -name "*.h" -newer "$$bitarray_lib" 2>/dev/null | head -3); \
		if [ -n "$$newer_files" ]; then \
			echo "  ‚ö†Ô∏è  Outdated: $$bitarray_lib"; \
			echo "     ‚Üí Newer sources detected: $$(echo "$$newer_files" | tr '\n' ' ')"; \
			echo "     ‚Üí Run: cd $$bitarray_src && make clean && make libbitarr.a"; \
		else \
			echo "  ‚úÖ Up-to-date: $$bitarray_lib"; \
		fi; \
	fi

# Check Cython source dependencies
check-cython-deps:
	@echo "üêç Cython Source Dependencies:"
	@need_rebuild=false; \
	missing_count=0; outdated_count=0; uptodate_count=0; \
	for version in $(PYTHON_VERSIONS); do \
		py_major_minor=$$(echo "$$version" | sed 's/\.//g'); \
		echo "  Python $$version ($$py_major_minor):"; \
		for mod in $(CORE_MODULES); do \
			pyx_file="$$mod.pyx"; \
			c_file="$${mod}_$$py_major_minor.c"; \
			if [ ! -f "$$pyx_file" ]; then \
				echo "    ‚ö†Ô∏è  No source: $$pyx_file (will use pre-built C)"; \
			elif [ ! -f "$$c_file" ]; then \
				echo "    ‚ùå Missing: $$c_file"; \
				missing_count=$$((missing_count + 1)); \
				need_rebuild=true; \
			elif [ "$$pyx_file" -nt "$$c_file" ]; then \
				echo "    ‚ö†Ô∏è  Outdated: $$c_file ($$pyx_file is newer)"; \
				outdated_count=$$((outdated_count + 1)); \
				need_rebuild=true; \
			else \
				uptodate_count=$$((uptodate_count + 1)); \
			fi; \
		done; \
	done; \
	echo ""; \
	echo "  üìä Summary: $$uptodate_count up-to-date, $$outdated_count outdated, $$missing_count missing"; \
	if [ "$$need_rebuild" = "true" ]; then \
		echo "  üîß Rebuild needed: make all (sequential) or make parallel (faster)"; \
	else \
		echo "  ‚úÖ All Cython sources are current"; \
	fi

# Check Docker environment dependencies
check-docker-deps:
	@echo "üê≥ Docker Environment Dependencies:"
	@if ! docker --version >/dev/null 2>&1; then \
		echo "  ‚ùå Docker not available"; \
		echo "     ‚Üí Install Docker to use containerized builds"; \
	else \
		echo "  ‚úÖ Docker available: $$(docker --version)"; \
	fi; \
	if ! docker-compose --version >/dev/null 2>&1; then \
		echo "  ‚ùå Docker Compose not available"; \
		echo "     ‚Üí Install Docker Compose for multi-version builds"; \
	else \
		echo "  ‚úÖ Docker Compose available: $$(docker-compose --version)"; \
	fi; \
	if [ -f "docker-compose.build.yml" ]; then \
		echo "  ‚úÖ Build configuration: docker-compose.build.yml"; \
	else \
		echo "  ‚ùå Missing: docker-compose.build.yml"; \
	fi

# Clean operations
clean-non-versioned:
	@echo "üßπ Cleaning non-versioned C sources..."
	@find PyMaSC -name "*.c" ! -name "*_[0-9][0-9].c" ! -name "*_[0-9][0-9][0-9].c" -delete

clean-versioned:
	@echo "üßπ Cleaning versioned C sources..."
	@find PyMaSC -name "*_[0-9][0-9].c" -delete
	@find PyMaSC -name "*_[0-9][0-9][0-9].c" -delete

clean-shared-libs:
	@echo "üßπ Cleaning compiled shared libraries (.so files)..."
	@so_count=$$(find PyMaSC -name "*.so" | wc -l | tr -d ' '); \
	if [ "$$so_count" -gt 0 ]; then \
		echo "  Removing $$so_count shared library files..."; \
		find PyMaSC -name "*.so" -delete; \
		echo "  ‚úÖ Shared libraries cleaned"; \
	else \
		echo "  ‚úÖ No shared libraries found"; \
	fi

clean-build-artifacts:
	@echo "üßπ Cleaning build artifacts..."
	@# Remove Python build directories
	@if [ -d "build" ]; then \
		echo "  Removing build/ directory..."; \
		rm -rf build; \
	fi
	@# Remove temporary extracted C cache
	@if [ -d "c_extracted" ]; then \
		echo "  Removing c_extracted/ directory..."; \
		rm -rf c_extracted; \
	fi
	@# Remove .egg-info directories
	@if find . -name "*.egg-info" -type d | grep -q .; then \
		echo "  Removing .egg-info directories..."; \
		find . -name "*.egg-info" -type d -exec rm -rf {} + 2>/dev/null || true; \
	fi
	@# Remove __pycache__ directories
	@pycache_count=$$(find . -name "__pycache__" -type d | wc -l | tr -d ' '); \
	if [ "$$pycache_count" -gt 0 ]; then \
		echo "  Removing $$pycache_count __pycache__ directories..."; \
		find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true; \
	fi
	@echo "  ‚úÖ Build artifacts cleaned"

clean: clean-non-versioned clean-versioned clean-shared-libs clean-build-artifacts docker-cleanup
	@echo ""
	@echo "üéâ Complete cleanup finished!"
	@echo "  - C source files (versioned and non-versioned)"
	@echo "  - Compiled shared libraries (.so)"
	@echo "  - Python build artifacts"
	@echo "  - Docker containers and volumes"

# Docker cleanup
docker-cleanup:
	@echo "üßπ Cleaning up Docker containers..."
	@docker-compose -f $(DOCKER_COMPOSE_FILE) down -v 2>/dev/null || true

# Platform information
platform-info:
	@echo "üîß Platform Information:"
	@echo "  System: $(UNAME_S) $(UNAME_M)"
	@echo "  Docker: $(DOCKER_PLATFORM)"
	@echo "  Note: $(PLATFORM_NOTE)"
	@echo ""

# Show summary of generated files
show-summary:
	@for version in $(PYTHON_VERSIONS); do \
		py_major_minor=$$(echo "$$version" | sed 's/\.//g'); \
		files=$$(find PyMaSC -name "*_$$py_major_minor.c" | wc -l | tr -d ' '); \
		if [ "$$files" -gt 0 ]; then \
			echo "  Python $$version: $$files files"; \
		fi; \
	done
	@total_files=$$(find PyMaSC -name "*.c" | wc -l | tr -d ' '); \
	echo "  Total C files: $$total_files"

# Development helpers
help:
	@echo "PyMaSC C Source Generation - Makefile.sources"
	@echo ""
	@echo "Main Commands:"
	@echo "  make all               - Build all versions sequentially with dependency tracking"
	@echo "  make parallel          - Build all versions in isolated containers (recommended)"
	@echo "  make parallel-staged   - Build all versions in staged groups (legacy)"
	@echo "  make extract           - Only extract/sync C sources from existing containers"
	@echo "  make py38              - Build only Python 3.8 sources"
	@echo "  make py39              - Build only Python 3.9 sources"
	@echo "  make py310             - Build only Python 3.10 sources"
	@echo "  make py311             - Build only Python 3.11 sources"
	@echo "  make py312             - Build only Python 3.12 sources"
	@echo "  make py313             - Build only Python 3.13 sources"
	@echo ""
	@echo "Cleaning Commands:"
	@echo "  make clean              - Complete cleanup (all sources, .so files, build artifacts)"
	@echo "  make clean-shared-libs  - Remove compiled .so files only"
	@echo "  make clean-versioned    - Remove versioned C files (*_38.c, *_39.c, etc.)"
	@echo "  make clean-build-artifacts - Remove build/, __pycache__, .egg-info"
	@echo ""
	@echo "Utility Commands:"
	@echo "  make check-deps   - Comprehensive dependency analysis"
	@echo "  make platform-info - Show platform and Docker configuration"
	@echo "  make help         - Show this help"
	@echo ""
	@echo "Expected Performance:"
	@echo "  Sequential (make all): ~15 minutes"
	@echo "  Isolated Parallel (make parallel): ~5-8 minutes (100% stable, race-free)"
	@echo "  Staged Parallel (make parallel-staged): ~8-12 minutes (legacy, resource-constrained)"

# Quick check command
check: check-deps platform-info
	@echo ""
	@echo "‚úÖ System check completed"

# Extract versioned C files from already-built containers and sync into repo
extract:
	@echo "üì• Extracting generated C files from existing containers via rsync..."
	@mkdir -p c_extracted
	@for version in $(PYTHON_VERSIONS); do \
		py_major_minor=$$(echo "$$version" | sed 's/\.//g'); \
		container="pymasc-build-py$$py_major_minor"; \
		tmpdir="c_extracted/py$$py_major_minor"; \
		echo "  Inspecting $$container ..."; \
		if docker inspect -f '{{.State.Status}}' "$$container" >/dev/null 2>&1; then \
			mkdir -p "$$tmpdir"; \
			if docker cp "$$container:/build/PyMaSC" "$$tmpdir/" 2>/dev/null; then \
				RSYNC_FILTER="--include=*/ --include=*_$${py_major_minor}.c --exclude=*"; \
				rsync -a --prune-empty-dirs $$RSYNC_FILTER "$$tmpdir/PyMaSC/" "PyMaSC/"; \
				echo "    ‚úÖ Synced Python $$version C sources"; \
			else \
				echo "    ‚ö†Ô∏è  Could not copy /build/PyMaSC from $$container (skipping)"; \
			fi; \
		else \
			echo "    ‚ùå Container $$container not found (skipping)"; \
		fi; \
	done
	@echo ""
	@$(MAKE) -f Makefile.sources show-summary
